###############################################################
# FILE: nginx/nginx.conf
# Role: Reverse proxy routing for production deployment.
# Agent boundary: Deployment layer (§9)
# Dependencies: frontend:5173 (Vite dev) or frontend:80 (prod nginx), api:8000, martin:3000
# Output: Single HTTP entry point on :80
# How to test: curl http://localhost/ (frontend), curl http://localhost/api/sorts (API)
#
# Routing:
#   /         → frontend (Vue SPA — catch-all for Vue Router)
#   /api/     → FastAPI (strip /api prefix)
#   /tiles/   → Martin (strip /tiles prefix)
#
# NOTE: Uses variable-based proxy_pass with Docker's embedded DNS resolver
# (127.0.0.11) so upstreams are resolved at request time rather than startup.
# This avoids "host not found" errors when upstream containers are still starting.
###############################################################

events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # Logging
    access_log /var/log/nginx/access.log;
    error_log  /var/log/nginx/error.log;

    # Use Docker's embedded DNS resolver so upstreams resolve at request time.
    resolver 127.0.0.11 valid=10s ipv6=off;

    # Gzip compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript
               application/x-javascript text/xml application/xml
               application/xml+rss text/javascript application/wasm;

    server {
        listen 80;
        server_name _;

        # ── FastAPI (/api/ → FastAPI root) ───────────────────────
        location /api/ {
            set $api_upstream http://api:8000;
            proxy_pass $api_upstream/api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_read_timeout 30s;
        }

        # ── Martin tile server (/tiles/ → Martin root) ──────────
        # Frontend tile URL: http://localhost/tiles/tile_heatmap/{z}/{x}/{y}?sort=X&metric=Y
        location /tiles/ {
            set $martin_upstream http://martin:3000;
            proxy_pass $martin_upstream/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_read_timeout 10s;
        }

        # ── Frontend (Vue SPA — catch-all) ──────────────────────
        # Dev mode: Vite dev server on 5173 handles all SPA routing natively.
        # For prod, change to frontend:80 and switch docker-compose target to 'prod'.
        location / {
            set $frontend_upstream http://frontend:5173;
            proxy_pass $frontend_upstream;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            # Required for Vite HMR WebSocket
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
}
